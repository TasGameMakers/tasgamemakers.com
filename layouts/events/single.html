{{ define "main" }}

<!-- Event Hero -->
<div class="page-hero event-page-hero" {{ with .Params.image }}style="background-image: url('/assets/media/images/{{ . }}');"{{ end }}>
  <div class="container">
    <h1 class="page-hero__title">{{ .Title }}</h1>
    {{ with .Params.summary }}
    <p class="page-hero__desc">{{ . }}</p>
    {{ end }}
  </div>
</div>

<!-- Event Content -->
<div class="page-content">
  <div class="container">
    <article class="event-article">

      <header class="event-article__header">
        <a href="/events/" class="event-article__back">&larr; Back to events</a>

        <div class="event-article__meta">
          <div class="event-article__meta-item">
            <strong>Date:</strong>
            {{ if .Params.end_date }}
              {{- $endDate := time .Params.end_date -}}
              {{- if eq (.Date.Format "2006-01-02") ($endDate.Format "2006-01-02") }}
                {{ .Date.Format "Monday, January 2, 2006" }}
              {{- else }}
                {{ .Date.Format "Monday, January 2" }} – {{ $endDate.Format "Monday, January 2, 2006" }}
              {{- end }}
            {{- else }}
              {{ .Date.Format "Monday, January 2, 2006" }}
            {{- end }}
          </div>
          {{- $tz := "AEST" -}}
          {{- if eq (.Date.Format "-0700") "+1100" }}{{ $tz = "AEDT" }}{{ end -}}
          <div class="event-article__meta-item">
            <strong>Time:</strong>
            {{ .Date.Format "3:04 PM" }}{{ with .Params.end_date }} – {{ (time .).Format "3:04 PM" }}{{ end }} {{ $tz }}
          </div>
          {{ with .Params.location }}
          <div class="event-article__meta-item">
            <strong>Location:</strong> {{ . }}
          </div>
          {{ end }}
          {{ with .Params.cost }}
          <div class="event-article__meta-item">
            <strong>Cost:</strong> {{ . }}
          </div>
          {{ end }}
        </div>

        {{ with .Params.discord_url }}
        <div class="event-article__cta">
          <a href="{{ . }}" class="btn-new btn-new--white" target="_blank" rel="noopener">Join us on Discord</a>
        </div>
        {{ end }}

        {{ with .Params.action_url }}
        <div class="event-article__cta">
          <a href="{{ . }}" class="btn-new btn-new--purple" target="_blank" rel="noopener">{{ $.Params.action_label | default "More Info" }}</a>
        </div>
        {{ else }}
        {{ if .Params.drop_in }}
        <div class="event-article__cta">
          <span class="btn-new btn-new--drop-in">Just turn up!</span>
        </div>
        {{ end }}
        {{ end }}
      </header>

      {{ with .Params.address }}
      <a href="https://www.google.com/maps/search/?api=1&query={{ . | urlquery }}" target="_blank" rel="noopener" class="event-article__map-link" id="event-map-link" style="display:none;">
        <div class="event-article__map" id="event-map" data-address="{{ . }}" data-label="{{ $.Params.location | default $.Title }}"></div>
        <span class="event-article__map-cta">Open in Google Maps</span>
      </a>
      {{ end }}

      <div class="prose">
        {{ .Content }}
      </div>

      {{ with .Params.action_url }}
      <div class="event-article__cta">
        <a href="{{ . }}" class="btn-new btn-new--purple" target="_blank" rel="noopener">{{ $.Params.action_label | default "More Info" }}</a>
      </div>
      {{ end }}

      <!-- Photo Gallery -->
      {{ with .Params.photos }}
      <section class="event-article__gallery">
        <h2>Photos</h2>
        <div class="photo-grid">
          {{ range . }}
          <figure class="photo-grid__item">
            <img src="/assets/media/images/{{ .src }}" alt="{{ .alt }}">
          </figure>
          {{ end }}
        </div>
      </section>
      {{ end }}

    </article>
  </div>
</div>

{{ with .Params.address }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(function() {
  var el = document.getElementById('event-map');
  if (!el) return;
  var address = el.dataset.address;
  var label = el.dataset.label;
  fetch('https://nominatim.openstreetmap.org/search?q=' + encodeURIComponent(address) + '&format=json&limit=1')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (!data.length) return;
      var link = document.getElementById('event-map-link');
      if (link) link.style.display = '';
      var lat = parseFloat(data[0].lat);
      var lon = parseFloat(data[0].lon);
      var map = L.map('event-map', {
        dragging: false,
        touchZoom: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        keyboard: false,
        zoomControl: false
      }).setView([lat, lon], 16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);
      L.marker([lat, lon]).addTo(map).bindPopup(label);
    });
})();
</script>
{{ end }}

{{ end }}
