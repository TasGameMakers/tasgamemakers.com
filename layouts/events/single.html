{{ define "main" }}

<div class="page-hero event-page-hero" {{ with .Params.image }}style="background-image: url('/assets/media/images/{{ . }}');"{{ end }}>
  <div class="container">
    <h1 class="page-hero__title">{{ .Title }}</h1>
    {{ with .Params.summary }}
    <p class="page-hero__desc">{{ . }}</p>
    {{ end }}
  </div>
</div>

<div class="page-content">
  <div class="container">
    <div class="event-layout">
    <article class="event-article">

      <header class="event-article__header">
        <a href="/events/" class="event-article__back">&larr; Back to events</a>

        {{ if lt (cond (isset .Params "end_date") (time .Params.end_date) .Date) now }}
        <div class="event-article__past-badge">Past Event</div>
        {{ end }}

        <div class="event-article__meta">
          <div class="event-article__meta-item">
            <strong>Date:</strong>
            {{ with .Params.date_display }}
              {{ . }}
            {{ else }}
              {{ if $.Params.end_date }}
                {{- $endDate := time $.Params.end_date -}}
                {{- if eq ($.Date.Format "2006-01-02") ($endDate.Format "2006-01-02") }}
                  {{ $.Date.Format "Monday, January 2, 2006" }}
                {{- else }}
                  {{ $.Date.Format "Monday, January 2" }} – {{ $endDate.Format "Monday, January 2, 2006" }}
                {{- end }}
              {{- else }}
                {{ $.Date.Format "Monday, January 2, 2006" }}
              {{- end }}
            {{ end }}
          </div>
          {{- $tz := "AEST" -}}
          {{- if eq (.Date.Format "-0700") "+1100" }}{{ $tz = "AEDT" }}{{ end -}}
          <div class="event-article__meta-item">
            <strong>Time:</strong>
            {{ with .Params.time_display }}
              {{ . }}
            {{ else }}
              {{ $.Date.Format "3:04 PM" }}{{ with $.Params.end_date }} – {{ (time .).Format "3:04 PM" }}{{ end }} {{ $tz }}
            {{ end }}
          </div>
          {{ with .Params.location }}
          <div class="event-article__meta-item">
            <strong>Location:</strong> {{ . }}
          </div>
          {{ end }}
          {{ with .Params.cost }}
          <div class="event-article__meta-item">
            <strong>Cost:</strong> {{ . }}
          </div>
          {{ end }}
        </div>

        {{ with .Params.discord_url }}
        <div class="event-article__cta">
          <a href="{{ . }}" class="btn-new btn-new--white" target="_blank" rel="noopener">Join us on Discord</a>
        </div>
        {{ end }}

        {{ with .Params.action_url }}
        <div class="event-article__cta">
          <a href="{{ . }}" class="btn-new btn-new--purple" target="_blank" rel="noopener">{{ $.Params.action_label | default "More Info" }}</a>
        </div>
        {{ else }}
        {{ if .Params.drop_in }}
        <div class="event-article__cta">
          <span class="btn-new btn-new--drop-in">Just turn up!</span>
        </div>
        {{ end }}
        {{ end }}

        {{/* Build ICS for download */}}
        {{- $ics_title := printf "Tas Game Makers: %s" .Title -}}
        {{- $ics_title = replace $ics_title "\\" "\\\\" -}}
        {{- $ics_title = replace $ics_title ";" "\\;" -}}
        {{- $ics_title = replace $ics_title "," "\\," -}}
        {{- $ics_title = replace $ics_title "\n" "\\n" -}}
        {{- $ics_desc := .Params.summary | default .Title -}}
        {{- $ics_desc = replace $ics_desc "\\" "\\\\" -}}
        {{- $ics_desc = replace $ics_desc ";" "\\;" -}}
        {{- $ics_desc = replace $ics_desc "," "\\," -}}
        {{- $ics_desc = replace $ics_desc "\n" "\\n" -}}
        {{- $ics_loc := "" -}}
        {{- with .Params.location -}}
          {{- $loc := replace . "\\" "\\\\" -}}
          {{- $loc = replace $loc ";" "\\;" -}}
          {{- $loc = replace $loc "," "\\," -}}
          {{- $ics_loc = printf "LOCATION:%s\r\n" $loc -}}
        {{- end -}}
        {{- $vevents := "" -}}
        {{- if .Params.event_days -}}
          {{- range $i, $day := .Params.event_days -}}
            {{- $dayStart := time $day.start -}}
            {{- $dayEnd := time $day.end -}}
            {{- $uid := printf "%s-day%d" $.Permalink $i -}}
            {{- $dayTitle := printf "%s (Day %d)" $ics_title (add $i 1) -}}
            {{- $vevents = printf "%sBEGIN:VEVENT\r\nUID:%s\r\nDTSTAMP:%s\r\nDTSTART:%s\r\nDTEND:%s\r\n%sSUMMARY:%s\r\nDESCRIPTION:%s\r\nURL:%s\r\nSTATUS:CONFIRMED\r\nEND:VEVENT\r\n" $vevents $uid (now.UTC.Format "20060102T150405Z") ($dayStart.UTC.Format "20060102T150405Z") ($dayEnd.UTC.Format "20060102T150405Z") $ics_loc $dayTitle $ics_desc $.Permalink -}}
          {{- end -}}
        {{- else -}}
          {{- $ics_dtend := "" -}}
          {{- with .Params.end_date -}}
            {{- $ics_dtend = printf "DTEND:%s\r\n" ((time .).UTC.Format "20060102T150405Z") -}}
          {{- end -}}
          {{- $vevents = printf "BEGIN:VEVENT\r\nUID:%s\r\nDTSTAMP:%s\r\nDTSTART:%s\r\n%s%sSUMMARY:%s\r\nDESCRIPTION:%s\r\nURL:%s\r\nSTATUS:CONFIRMED\r\nEND:VEVENT\r\n" .Permalink (now.UTC.Format "20060102T150405Z") (.Date.UTC.Format "20060102T150405Z") $ics_dtend $ics_loc $ics_title $ics_desc .Permalink -}}
        {{- end -}}
        {{- $ics := printf "BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Tas Game Makers//Events//EN\r\n%sEND:VCALENDAR\r\n" $vevents -}}
        <div class="event-article__cta">
          <a href="data:text/calendar;base64,{{ $ics | base64Encode }}" download="{{ .File.ContentBaseName }}.ics" class="btn-new btn-new--outline-dark">Add to Calendar</a>
        </div>
      </header>

      {{ with .Params.address }}
      <a href="https://www.google.com/maps/search/?api=1&query={{ . | urlquery }}" target="_blank" rel="noopener" class="event-article__map-link" id="event-map-link" style="display:none;">
        <div class="event-article__map" id="event-map" data-address="{{ . }}" data-label="{{ $.Params.location | default $.Title }}"></div>
        <span class="event-article__map-cta">Open in Google Maps</span>
      </a>
      {{ end }}

      <div class="prose">
        {{ .Content }}
      </div>

      {{ with .Params.action_url }}
      <div class="event-article__cta">
        <a href="{{ . }}" class="btn-new btn-new--purple" target="_blank" rel="noopener">{{ $.Params.action_label | default "More Info" }}</a>
      </div>
      {{ end }}

      {{ with .Params.photos }}
      <section class="event-article__gallery">
        <h2>Photos</h2>
        <div class="photo-grid">
          {{ range . }}
          <figure class="photo-grid__item">
            <img src="/assets/media/images/{{ .src }}" alt="{{ .alt }}">
          </figure>
          {{ end }}
        </div>
      </section>
      {{ end }}

    </article>

    {{ with .Params.image }}
    <aside class="event-sidebar">
      <img src="/assets/media/images/{{ . }}" alt="{{ $.Title }}" class="event-sidebar__image">
    </aside>
    {{ end }}
    </div>
  </div>
</div>

{{ with .Params.address }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(function() {
  var el = document.getElementById('event-map');
  if (!el) return;
  var address = el.dataset.address;
  var label = el.dataset.label;
  fetch('https://nominatim.openstreetmap.org/search?q=' + encodeURIComponent(address) + '&format=json&limit=1')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (!data.length) return;
      var link = document.getElementById('event-map-link');
      if (link) link.style.display = '';
      var lat = parseFloat(data[0].lat);
      var lon = parseFloat(data[0].lon);
      var map = L.map('event-map', {
        dragging: false,
        touchZoom: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        keyboard: false,
        zoomControl: false
      }).setView([lat, lon], 16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);
      L.marker([lat, lon]).addTo(map).bindPopup(label);
    });
})();
</script>
{{ end }}

{{ end }}
